@model DashboardModel
@{
    Layout = "_AdminLayout";
    ViewBag.PageTitle = T("Plugins.Misc.PaymentGuard.Menu.Dashboard").Text;

    //active menu item (system name)
    NopHtml.SetActiveMenuItemSystemName("PaymentGuard.Menu.Dashboard");
}

@{
    var complianceScoreClass = Model.ComplianceScore >= 95 ? "success" : Model.ComplianceScore >= 80 ? "warning" : "danger";
    var complianceScoreText = Model.ComplianceScore >= 95 ? "Plugins.Misc.PaymentGuard.Dashboard.ComplianceExcellent" : Model.ComplianceScore >= 80 ? "Plugins.Misc.PaymentGuard.Dashboard.ComplianceGood" : "Plugins.Misc.PaymentGuard.Dashboard.ComplianceNeedsAttention";
}

<div class="content-header clearfix">
    <h1 class="float-left">
        @T("Plugins.Misc.PaymentGuard.Menu.Dashboard")
    </h1>
    <div class="float-right">

        <!-- Time Period Filter -->
        <div class="btn-group">
            <button type="button" class="btn btn-info">
                <i class="fas fa-calendar"></i>
                @Model.AvailableDayOptions.FirstOrDefault(x => x.Selected)?.Text
            </button>
            <button type="button" class="btn btn-info dropdown-toggle dropdown-icon" data-toggle="dropdown" aria-expanded="false">
                <span class="sr-only">&nbsp;</span>
            </button>
            <ul class="dropdown-menu" role="menu">
                @foreach (var option in Model.AvailableDayOptions)
                {
                    <li class="dropdown-item">
                        <a class="dropdown-item @(option.Selected ? "active" : "")" href="@Url.Action("Dashboard", new { days = option.Value })">
                            <i class="far fa-calendar"></i>
                            @option.Text
                        </a>
                    </li>
                }
            </ul>
        </div>

        <button type="button" class="btn btn-primary" onclick="refreshDashboard()">
            <i class="fas fa-sync"></i> @T("Plugins.Misc.PaymentGuard.Dashboard.Refresh")
        </button>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-4 mx-auto text-center">
                <nop-select asp-for="SearchStoreId" asp-items="Model.AvailableStores" onchange="refreshDashboard()" />
                <br />
            </div>
        </div>

        <!-- System Status Alert -->
        @if (Model.HasCriticalIssues)
        {
            <div class="row">
                <div class="col-md-12">
                    <div class="alert alert-danger">
                        <h4><i class="fas fa-exclamation-triangle"></i> @T("Plugins.Misc.PaymentGuard.Dashboard.CriticalAlertsDetected")</h4>
                        <p>@T("Plugins.Misc.PaymentGuard.Dashboard.CriticalAlertsMessage", Model.CriticalAlertsCount)</p>
                        <a href="@Url.Action("List", "ComplianceAlert", new { SearchIsResolved = "false", SearchAlertLevel = "critical" })" class="btn btn-danger">
                            @T("Plugins.Misc.PaymentGuard.Dashboard.ViewCriticalAlerts")
                        </a>
                    </div>
                    <br />
                </div>
            </div>
        }

        <!-- Key Metrics Cards - Enhanced -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>@Model.TotalScriptsMonitored</h3>
                        <p>@T("Plugins.Misc.PaymentGuard.Dashboard.TotalScriptsMonitoredLabel")</p>
                        @if (Model.ComplianceMetrics.ScriptsAddedThisWeek > 0)
                        {
                            <small class="text-light"><i class="fas fa-arrow-up"></i> +@Model.ComplianceMetrics.ScriptsAddedThisWeek @T("Plugins.Misc.PaymentGuard.Dashboard.NewThisWeek")</small>
                        }
                    </div>
                    <div class="icon">
                        <i class="fas fa-code"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box @(Model.ComplianceScore >= 95 ? "bg-success" : Model.ComplianceScore >= 80 ? "bg-warning" : "bg-danger")">
                    <div class="inner">
                        <h3>@Model.ComplianceScore.ToString("F1")%</h3>
                        <p>@T("Plugins.Misc.PaymentGuard.Dashboard.ComplianceScoreLabel")</p>
                        @if (Math.Abs(Model.ComplianceMetrics.ComplianceImprovement) > 0.1)
                        {
                            <small class="@(Model.ComplianceMetrics.ComplianceImprovement > 0 ? "text-light" : "text-light")">
                                <i class="fas fa-arrow-@(Model.ComplianceMetrics.ComplianceImprovement > 0 ? "up" : "down")"></i>
                                @Math.Abs(Model.ComplianceMetrics.ComplianceImprovement).ToString("F1")% @T("Plugins.Misc.PaymentGuard.Dashboard.VsLastWeek")
                            </small>
                        }
                    </div>
                    <div class="icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box @(Model.HasActiveAlerts ? "bg-warning" : "bg-success")">
                    <div class="inner">
                        <h3>@Model.ActiveAlertsCount</h3>
                        <p>@T("Plugins.Misc.PaymentGuard.Dashboard.ActiveAlertsLabel")</p>
                        <small class="@(Model.HasActiveAlerts ? "text-dark" : "text-light")">
                            @if (Model.NewAlertsToday > 0)
                            {
                                <i class="fas fa-plus"></i> @Model.NewAlertsToday @T("Plugins.Misc.PaymentGuard.Dashboard.NewToday")
                            }
                            else
                            {
                                <i class="fas fa-check"></i> @T("Plugins.Misc.PaymentGuard.Dashboard.NoNewAlerts")
                            }
                        </small>
                    </div>
                    <div class="icon">
                        <i class="fas fa-@(Model.HasActiveAlerts ? "exclamation-triangle" : "check-shield")"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-primary">
                    <div class="inner">
                        <h3>@Model.RealTimeMetrics.AlertsLast24Hours</h3>
                        <p>@T("Plugins.Misc.PaymentGuard.Dashboard.AlertsLast24Hours")</p>
                        <small class="text-light">
                            @T("Plugins.Misc.PaymentGuard.Dashboard.SystemStatus"):
                            <span class="badge @Model.SystemStatusBadgeClass">@Model.SystemStatusText</span>
                        </small>
                    </div>
                    <div class="icon">
                        <i class="fas fa-bell"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-teal">
                    <div class="inner">
                        <h3>@Model.AuthorizedScriptsCount</h3>
                        <p>@T("Plugins.Misc.PaymentGuard.Dashboard.AuthorizedScriptsLabel")</p>
                        <small class="text-light">@T("Plugins.Misc.PaymentGuard.Dashboard.SecureCompliant")</small>
                    </div>
                    <div class="icon">
                        <i class="fas fa-check-shield"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>@Model.UnauthorizedScriptsCount</h3>
                        <p>@T("Plugins.Misc.PaymentGuard.Dashboard.UnauthorizedScriptsLabel")</p>
                        @if (Model.ComplianceMetrics.NewAlertsThisWeek > 0)
                        {
                            <small class="text-dark"><i class="fas fa-exclamation-triangle"></i> @Model.ComplianceMetrics.NewAlertsThisWeek @T("Plugins.Misc.PaymentGuard.Dashboard.NewThisWeek")</small>
                        }
                    </div>
                    <div class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-Time Monitoring Status -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-heartbeat"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.RealTimeStatus")
                        </h3>
                        <div class="card-tools">
                            <span class="badge @Model.SystemStatusBadgeClass">@Model.SystemStatusText</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="description-block">
                                    <h5 class="description-header">@Model.RealTimeMetrics.ActiveMonitoringSessions</h5>
                                    <span class="description-text">@T("Plugins.Misc.PaymentGuard.Dashboard.ActiveSessions")</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="description-block">
                                    <h5 class="description-header">@Model.RealTimeMetrics.AlertsLastHour</h5>
                                    <span class="description-text">@T("Plugins.Misc.PaymentGuard.Dashboard.AlertsLastHour")</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="description-block">
                                    <h5 class="description-header">@Model.LastAlertTimeText</h5>
                                    <span class="description-text">@T("Plugins.Misc.PaymentGuard.Dashboard.LastAlert")</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="description-block">
                                    <h5 class="description-header">@Model.AlertResolutionRate.ToString("F1")%</h5>
                                    <span class="description-text">@T("Plugins.Misc.PaymentGuard.Dashboard.ResolutionRate")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compliance Metrics Summary -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-bar"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.ComplianceOverview")
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-info"><i class="fas fa-clock"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">@T("Plugins.Misc.PaymentGuard.Dashboard.AvgResolutionTime")</span>
                                        <span class="info-box-number">@Model.ComplianceMetrics.AverageResolutionTime.ToString("F1")h</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-success"><i class="fas fa-check"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">@T("Plugins.Misc.PaymentGuard.Dashboard.ResolvedThisWeek")</span>
                                        <span class="info-box-number">@Model.ComplianceMetrics.ResolvedAlertsThisWeek</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-warning"><i class="fas fa-bell"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">@T("Plugins.Misc.PaymentGuard.Dashboard.NewAlerts")</span>
                                        <span class="info-box-number">@Model.ComplianceMetrics.NewAlertsThisWeek</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-primary"><i class="fas fa-shield-alt"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">@T("Plugins.Misc.PaymentGuard.Dashboard.SecurityPosture")</span>
                                        <span class="info-box-number">@Model.ComplianceMetrics.SecurityPosture.ToString("F1")%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Alerts & Charts Row -->
        <div class="row">
            <!-- Recent Alerts -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bell"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.RecentAlerts")
                        </h3>
                        <div class="card-tools">
                            <a href="@Url.Action("List", "ComplianceAlert")" class="btn btn-sm btn-outline-primary">
                                @T("Plugins.Misc.PaymentGuard.Dashboard.ViewAll")
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                        @if (Model.RecentAlerts.Any())
                        {
                            <table class="table table-sm table-striped">
                                <tbody>
                                    @foreach (var alert in Model.RecentAlerts)
                                    {
                                        <tr>
                                            <td>
                                                <span class="badge @alert.BadgeClass">@alert.AlertLevel</span>
                                            </td>
                                            <td>
                                                <strong>@alert.AlertType</strong><br>
                                                <small class="text-muted" title="@alert.Message">
                                                    @(alert.Message.Length > 50 ? alert.Message.Substring(0, 50) + "..." : alert.Message)
                                                </small>
                                            </td>
                                            <td>
                                                <small>@alert.TimeAgo</small>
                                                @if (alert.IsResolved)
                                                {
                                                    <br>

                                                    <span class="badge badge-success badge-sm">@T("Plugins.Misc.PaymentGuard.Dashboard.Resolved")</span>
                                                }
                                            </td>
                                            <td>
                                                <a href="@Url.Action("Details", "ComplianceAlert", new { id = alert.Id })" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-check-circle fa-2x mb-2"></i>
                                <p>@T("Plugins.Misc.PaymentGuard.Dashboard.NoRecentAlerts")</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Top Violating Scripts -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.TopViolatingScripts")
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>@T("Plugins.Misc.PaymentGuard.Dashboard.Script")</th>
                                    <th>@T("Plugins.Misc.PaymentGuard.Dashboard.Violations")</th>
                                    <th>@T("Plugins.Misc.PaymentGuard.Dashboard.Risk")</th>
                                    <th>@T("Plugins.Misc.PaymentGuard.Dashboard.LastSeen")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.TopViolatingScripts.Any())
                                {
                                    @foreach (var script in Model.TopViolatingScripts.Take(5))
                                    {
                                        <tr>
                                            <td>
                                                <small title="@script.ScriptUrl">@script.ScriptUrl</small>
                                            </td>
                                            <td>
                                                <span class="badge badge-danger">@script.ViolationCount</span>
                                            </td>
                                            <td>
                                                <span class="badge badge-@(script.RiskLevelId == (int)RiskLevel.High ? "danger" : script.RiskLevelId == (int)RiskLevel.Medium ? "warning" : "success")">
                                                    @script.RiskLevelText
                                                </span>
                                            </td>
                                            <td><small>@script.LastViolation</small></td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            <i class="fas fa-check-circle"></i> @T("Plugins.Misc.PaymentGuard.Dashboard.NoViolationsDetected")
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        @if (Model.ExpiredScriptsCount > 0)
        {
            <div class="row">
                <div class="col-md-12">
                    <div class="alert alert-warning">
                        <h4><i class="fas fa-exclamation-triangle"></i> @T("Plugins.Misc.PaymentGuard.Dashboard.ScriptsVerificationLabel")</h4>
                        <p>@Html.Raw(string.Format(T("Plugins.Misc.PaymentGuard.Dashboard.ScriptsVerificationDetail").Text, Model.ExpiredScriptsCount))</p>
                        <ul>
                            @foreach (var script in Model.ExpiredScripts)
                            {
                                <li><code>@script.ScriptUrl</code> - @script.DaysExpired @T("Plugins.Misc.PaymentGuard.Dashboard.ScriptsVerificationDaysDue")</li>
                            }
                        </ul>
                        <a href="@Url.Action("List")" class="btn btn-warning">@T("Plugins.Misc.PaymentGuard.Dashboard.ScriptsVerificationReview")</a>
                    </div>
                    <br />
                </div>
            </div>
        }

        <!-- Charts Row -->
        <div class="row">
            <!-- Compliance History Chart -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-line"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.ComplianceTrends")
                        </h3>
                    </div>
                    <div class="card-body">
                        <canvas id="complianceHistoryChart" height="100"></canvas>
                    </div>
                </div>
            </div>

            <!-- Alert Types Distribution -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.AlertTypesDistribution")
                        </h3>
                    </div>
                    <div class="card-body">
                        <canvas id="alertTypePieChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Charts Row -->
        <div class="row">
            <!-- Monitoring Trends -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-search"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.MonitoringActivity")
                        </h3>
                    </div>
                    <div class="card-body">
                        <canvas id="monitoringTrendsChart" height="150"></canvas>
                    </div>
                </div>
            </div>

            <!-- Risk Level Breakdown -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-exclamation-circle"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.RiskLevelBreakdown")
                        </h3>
                    </div>
                    <div class="card-body">
                        <canvas id="riskLevelChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics & Top Violating Scripts -->
        <div class="row">
            <!-- Performance Metrics -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-tachometer-alt"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.PerformanceMetrics")
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="description-block">
                                    <h5 class="description-header">@Model.PerformanceMetrics.AverageMonitoringTime.ToString("F1")s</h5>
                                    <span class="description-text">@T("Plugins.Misc.PaymentGuard.Dashboard.AvgResponseTime")</span>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="description-block">
                                    <h5 class="description-header">@Model.PerformanceMetrics.SystemUptime.ToString("F1")%</h5>
                                    <span class="description-text">@T("Plugins.Misc.PaymentGuard.Dashboard.SystemUptime")</span>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="description-block">
                                    <h5 class="description-header">@Model.PerformanceMetrics.CacheHitRate.ToString("F1")%</h5>
                                    <span class="description-text">@T("Plugins.Misc.PaymentGuard.Dashboard.CacheHitRate")</span>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="description-block">
                                    <h5 class="description-header">@Model.PerformanceMetrics.ApiCallsThisWeek</h5>
                                    <span class="description-text">@T("Plugins.Misc.PaymentGuard.Dashboard.ApiCallsThisWeek")</span>
                                </div>
                            </div>
                        </div>
                        <div class="progress-group mt-3">
                            @T("Plugins.Misc.PaymentGuard.Dashboard.SuccessRate")
                            <span class="float-right">
                                @{
                                    var successRate = Model.PerformanceMetrics.SuccessfulChecks + Model.PerformanceMetrics.FailedChecks > 0 
                                        ? (double)Model.PerformanceMetrics.SuccessfulChecks / (Model.PerformanceMetrics.SuccessfulChecks + Model.PerformanceMetrics.FailedChecks) * 100 
                                        : 100;
                                }
                                @successRate.ToString("F1")%
                            </span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-success" style="width: @successRate%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Alert Trends Chart -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-line"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.AlertTrends")
                        </h3>
                    </div>
                    <div class="card-body">
                        <canvas id="alertTrendsChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance & Resolution Metrics -->
        <div class="row">
            <!-- Resolution Performance -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-stopwatch"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.ResolutionPerformance")
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="description-block">
                                    <h5 class="description-header">@Model.AverageResolutionTimeHours.ToString("F1")h</h5>
                                    <span class="description-text">@T("Plugins.Misc.PaymentGuard.Dashboard.AvgResolutionTime")</span>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="description-block">
                                    <h5 class="description-header">@Model.ComplianceMetrics.ResolvedAlertsThisWeek</h5>
                                    <span class="description-text">@T("Plugins.Misc.PaymentGuard.Dashboard.ResolvedThisWeek")</span>
                                </div>
                            </div>
                        </div>
                        <canvas id="resolutionPerformanceChart" height="150"></canvas>
                    </div>
                </div>
            </div>

            <!-- Alert Type Distribution -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie"></i>
                            @T("Plugins.Misc.PaymentGuard.Dashboard.AlertTypesDistribution")
                        </h3>
                    </div>
                    <div class="card-body">
                        <canvas id="alertTypeDistributionChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(document).ready(function() {
        initializeCharts();

        initializeAlertCharts();
        // Also initialize existing charts
        initializeExistingCharts();

        // Auto-refresh every 5 minutes for real-time data
        setInterval(function() {
            refreshDashboard(false); // Silent refresh
        }, 300000);
    });

    function initializeCharts() {
        // Compliance History Line Chart
        initComplianceHistoryChart();
        
        // Alert Types Pie Chart
        initAlertTypePieChart();
        
        // Monitoring Trends Chart
        initMonitoringTrendsChart();
        
        // Risk Level Doughnut Chart
        initRiskLevelChart();
    }

    function initComplianceHistoryChart() {
        var ctx = document.getElementById('complianceHistoryChart').getContext('2d');
        var complianceData = @Html.Raw(Json.Serialize(Model.ComplianceHistoryData));

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: complianceData.map(function(item) {
                    return new Date(item.Date).toLocaleDateString();
                }),
                datasets: [{
                    label: 'Compliance Score (%)',
                    data: complianceData.map(function(item) { return item.ComplianceScore; }),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Total Scripts',
                    data: complianceData.map(function(item) { return item.TotalScripts; }),
                    borderColor: '#6c757d',
                    backgroundColor: 'rgba(108, 117, 125, 0.1)',
                    fill: false,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 0,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                if (context[0].dataIndex !== undefined) {
                                    var data = complianceData[context[0].dataIndex];
                                    return [
                                        'Authorized: ' + data.AuthorizedScripts,
                                        'Unauthorized: ' + data.UnauthorizedScripts
                                    ];
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    function initAlertTypePieChart() {
        var ctx = document.getElementById('alertTypePieChart').getContext('2d');
        var alertData = @Html.Raw(Json.Serialize(Model.AlertTypeDistribution));

        if (alertData.length === 0) {
            ctx.fillText('@T("Plugins.Misc.PaymentGuard.Dashboard.NoAlertsInSelectedPeriod")', 10, 50);
            return;
        }

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: alertData.map(function(item) { return item.AlertType; }),
                datasets: [{
                    data: alertData.map(function(item) { return item.Count; }),
                    backgroundColor: alertData.map(function(item) { return item.Color; }),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var label = context.label || '';
                                var value = context.parsed;
                                var total = alertData.reduce(function(sum, item) { return sum + item.Count; }, 0);
                                var percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    function initMonitoringTrendsChart() {
        var ctx = document.getElementById('monitoringTrendsChart').getContext('2d');
        var trendData = @Html.Raw(Json.Serialize(Model.MonitoringTrends));

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: trendData.map(function(item) {
                    return new Date(item.Date).toLocaleDateString();
                }),
                datasets: [{
                    label: 'Checks Performed',
                    data: trendData.map(function(item) { return item.ChecksPerformed; }),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }, {
                    label: 'Issues Found',
                    data: trendData.map(function(item) { return item.IssuesFound; }),
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            }
        });
    }

    function initRiskLevelChart() {
        var ctx = document.getElementById('riskLevelChart').getContext('2d');
        var riskData = @Html.Raw(Json.Serialize(Model.RiskLevelBreakdown));

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: riskData.map(function(item) { return item.RiskLevel; }),
                datasets: [{
                    data: riskData.map(function(item) { return item.Count; }),
                    backgroundColor: riskData.map(function(item) { return item.Color; }),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                cutout: '50%',
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var label = context.label || '';
                                var value = context.parsed;
                                var total = riskData.reduce(function(sum, item) { return sum + item.Count; }, 0);
                                var percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + value + ' scripts (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    function initializeAlertCharts() {
        // Alert Trends Chart
        initAlertTrendsChart();

        // Resolution Performance Chart
        initResolutionPerformanceChart();

        // Alert Type Distribution Chart
        initAlertTypeDistributionChart();
    }

    function initAlertTrendsChart() {
        var ctx = document.getElementById('alertTrendsChart').getContext('2d');
        var alertTrendData = @Html.Raw(Json.Serialize(Model.AlertTrends));
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: alertTrendData.map(function(item) {
                    return new Date(item.Date).toLocaleDateString();
                }),
                datasets: [{
                    label: 'Critical Alerts',
                    data: alertTrendData.map(function(item) { return item.CriticalAlerts; }),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    fill: true
                }, {
                    label: 'Warning Alerts',
                    data: alertTrendData.map(function(item) { return item.WarningAlerts; }),
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    fill: true
                }, {
                    label: 'Info Alerts',
                    data: alertTrendData.map(function(item) { return item.InfoAlerts; }),
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function initResolutionPerformanceChart() {
        var ctx = document.getElementById('resolutionPerformanceChart').getContext('2d');
        var resolutionData = @Html.Raw(Json.Serialize(Model.ResolutionPerformance));

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: resolutionData.map(function(item) {
                    return new Date(item.Date).toLocaleDateString();
                }),
                datasets: [{
                    label: 'Alerts Resolved',
                    data: resolutionData.map(function(item) { return item.AlertsResolved; }),
                    backgroundColor: 'rgba(40, 167, 69, 0.8)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    yAxisID: 'y'
                }, {
                    label: 'Avg Resolution Time (hours)',
                    data: resolutionData.map(function(item) { return item.AverageResolutionTimeHours; }),
                    type: 'line',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function initAlertTypeDistributionChart() {
        var ctx = document.getElementById('alertTypeDistributionChart').getContext('2d');
        var alertTypeData = @Html.Raw(Json.Serialize(Model.AlertTypeDistribution));

        if (alertTypeData.length === 0) {
            ctx.font = '16px Arial';
            ctx.fillText('@T("Plugins.Misc.PaymentGuard.Dashboard.NoAlertsInSelectedPeriod")', 10, 50);
            return;
        }

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: alertTypeData.map(function(item) { return item.AlertType; }),
                datasets: [{
                    data: alertTypeData.map(function(item) { return item.Count; }),
                    backgroundColor: alertTypeData.map(function(item) { return item.Color; }),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var label = context.label || '';
                                var value = context.parsed;
                                var total = alertTypeData.reduce(function(sum, item) { return sum + item.Count; }, 0);
                                var percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    function refreshDashboard(showLoading = true) {
        if (showLoading) {
            var refreshBtn = $('button:contains("@T("Plugins.Misc.PaymentGuard.Dashboard.Refresh")")');
            var originalHtml = refreshBtn.html();
            refreshBtn.html('<i class="fas fa-spinner fa-spin"></i> @T("Plugins.Misc.PaymentGuard.Dashboard.Loading")').prop('disabled', true);
        }

        var currentDays = @Model.SelectedDays;

        var data = { storeId : $('#SearchStoreId').val(), days: currentDays };
        addAntiForgeryToken(data);
        $.post('@Url.Action("RefreshDashboardData")', data)
            .done(function(result) {
                if (result.success && showLoading) {
                    updateDashboardMetrics(result.data);
                    toastr.success('@T("Plugins.Misc.PaymentGuard.Dashboard.RefreshSuccess")');
                } else if (!result.success && showLoading) {
                    toastr.error(result.message || '@T("Plugins.Misc.PaymentGuard.Dashboard.RefreshError")');
                }
            })
            .fail(function() {
                if (showLoading) {
                    toastr.error('@T("Plugins.Misc.PaymentGuard.Dashboard.RefreshError")');
                }
            })
            .always(function() {
                if (showLoading) {
                    var refreshBtn = $('button:contains("@T("Plugins.Misc.PaymentGuard.Dashboard.Loading")")');
                    if (refreshBtn.length === 0) {
                        refreshBtn = $('button:contains("@T("Plugins.Misc.PaymentGuard.Dashboard.Refresh")")');
                    }
                    refreshBtn.html('<i class="fas fa-sync"></i> @T("Plugins.Misc.PaymentGuard.Dashboard.Refresh")').prop('disabled', false);
                }
            });
    }

    function updateDashboardMetrics(data) {
        // Update key metrics
        $('.small-box.bg-info h3').text(data.totalScripts);
        $('.small-box h3:contains("@Model.ActiveAlertsCount")').text(data.activeAlerts);
        $('.small-box h3:contains("@Model.ComplianceScore")').text(data.complianceScore.toFixed(1) + '%');
    }

    // Placeholder for existing chart initialization
    function initializeExistingCharts() {
        // Your existing chart initialization code goes here
    }

    <!-- Enhanced refresh functionality -->
    function refreshDashboard() {
        // Show loading state
        var refreshBtn = $('button:contains("@T("Plugins.Misc.PaymentGuard.Dashboard.Refresh")")');
        var originalHtml = refreshBtn.html();
        refreshBtn.html('<i class="fas fa-spinner fa-spin"></i> @T("Plugins.Misc.PaymentGuard.Dashboard.Loading")').prop('disabled', true);

        // Get current days filter
        var currentDays = @Model.SelectedDays;

        var data = { storeId : $('#SearchStoreId').val(), days: currentDays };
        addAntiForgeryToken(data);
        $.post('@Url.Action("RefreshDashboardData")', data)
            .done(function(result) {
                if (result.success) {
                    // Update key metrics without full page reload
                    updateDashboardMetrics(result.data);
                
                    // Optionally reload charts with new data
                    // initializeCharts();
                
                    // Show success notification
                    toastr.success('Dashboard refreshed successfully');
                } else {
                    toastr.error(result.message || 'Error refreshing dashboard');
                }
            })
            .fail(function() {
                toastr.error('Error communicating with server');
            })
            .always(function() {
                // Restore button state
                refreshBtn.html(originalHtml).prop('disabled', false);
            });
    }

    function updateDashboardMetrics(data) {
        // Update the small boxes with new data
        $('.small-box.bg-info h3').text(data.totalScripts);
        $('.small-box.bg-success h3').text(data.authorizedScripts);
        $('.small-box.bg-warning h3').text(data.unauthorizedScripts);
        $('.small-box:last h3').text(data.complianceScore.toFixed(1) + '%');
    
        // Update any other visible metrics
        $('.description-text:contains("Last Check")').parent().find('.description-header').text(data.lastCheck);
    }
</script>

<style>
    .small-box .inner small {
        font-size: 0.8em;
        font-weight: normal;
    }
    
    .description-block {
        text-align: center;
        border-right: 1px solid #dee2e6;
        margin-bottom: 10px;
    }
    
    .description-block:last-child {
        border-right: none;
    }
    
    .info-box {
        box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
        border-radius: .25rem;
        background: #fff;
        display: flex;
        margin-bottom: 1rem;
        min-height: 80px;
        padding: .5rem;
        position: relative;
    }
    
    .info-box .info-box-icon {
        border-radius: .25rem;
        align-items: center;
        display: flex;
        font-size: 1.875rem;
        justify-content: center;
        text-align: center;
        width: 70px;
    }
    
    .info-box .info-box-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        line-height: 1.8;
        margin-left: .5rem;
        padding: 0 10px;
    }
    
    .info-box .info-box-number {
        display: block;
        font-weight: 700;
        font-size: 18px;
    }
    
    .info-box .info-box-text {
        display: block;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .progress-group {
        margin-bottom: 15px;
    }
</style>